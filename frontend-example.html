<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RemitScout Frontend Example</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #loading, #error {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        #loading {
            background-color: #f9f9f9;
            display: none;
        }
        #error {
            background-color: #f8d7da;
            color: #721c24;
            display: none;
        }
        .quote-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .provider-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .quote-detail {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            border-bottom: 1px solid #f1f1f1;
            padding-bottom: 5px;
        }
        .quote-detail:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: bold;
        }
        .best-rate {
            border-left: 5px solid #27ae60;
        }
        .best-fee {
            border-left: 5px solid #f39c12;
        }
        .fastest {
            border-left: 5px solid #e74c3c;
        }
        .sort-buttons {
            margin-bottom: 20px;
        }
        .sort-buttons button {
            margin-right: 10px;
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        .sort-buttons button.active {
            background-color: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <h1>RemitScout - Compare Remittance Rates</h1>
    
    <form id="quote-form">
        <div class="form-row">
            <div>
                <label for="source-country">From Country:</label>
                <select id="source-country" required>
                    <option value="US">United States (US)</option>
                    <option value="CA">Canada (CA)</option>
                    <option value="GB">United Kingdom (GB)</option>
                    <option value="AU">Australia (AU)</option>
                </select>
            </div>
            <div>
                <label for="source-currency">From Currency:</label>
                <select id="source-currency" required>
                    <option value="USD">US Dollar (USD)</option>
                    <option value="CAD">Canadian Dollar (CAD)</option>
                    <option value="GBP">British Pound (GBP)</option>
                    <option value="AUD">Australian Dollar (AUD)</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div>
                <label for="dest-country">To Country:</label>
                <select id="dest-country" required>
                    <option value="MX">Mexico (MX)</option>
                    <option value="IN">India (IN)</option>
                    <option value="PH">Philippines (PH)</option>
                    <option value="CN">China (CN)</option>
                </select>
            </div>
            <div>
                <label for="dest-currency">To Currency:</label>
                <select id="dest-currency" required>
                    <option value="MXN">Mexican Peso (MXN)</option>
                    <option value="INR">Indian Rupee (INR)</option>
                    <option value="PHP">Philippine Peso (PHP)</option>
                    <option value="CNY">Chinese Yuan (CNY)</option>
                </select>
            </div>
        </div>
        
        <div>
            <label for="amount">Amount to Send:</label>
            <input type="number" id="amount" placeholder="1000" min="1" value="1000" required>
        </div>
        
        <button type="submit">Compare Rates</button>
    </form>
    
    <!-- Results container -->
    <div id="results-container" style="display: none;">
        <h2>Remittance Quotes</h2>
        
        <div id="cache-status" style="margin: 10px 0; padding: 8px; background-color: #f1f8ff; border-radius: 4px; border-left: 4px solid #3498db;">
            <span id="cache-message">Loading quotes...</span>
        </div>
        
        <div class="sort-buttons">
            <button type="button" id="sort-rate" class="active">Best Exchange Rate</button>
            <button type="button" id="sort-fee">Lowest Fee</button>
            <button type="button" id="sort-time">Fastest Transfer</button>
        </div>
        
        <div id="quote-list">
            <!-- Quote cards will be inserted here -->
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading">
        <p>Loading quotes. Please wait...</p>
    </div>

    <!-- Error display -->
    <div id="error">
        <p id="error-message"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('quote-form');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            const resultsContainer = document.getElementById('results-container');
            const quoteList = document.getElementById('quote-list');
            const cacheMessage = document.getElementById('cache-message');
            
            // Sort buttons
            const sortRateBtn = document.getElementById('sort-rate');
            const sortFeeBtn = document.getElementById('sort-fee');
            const sortTimeBtn = document.getElementById('sort-time');
            
            // Handle form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Show loading indicator
                loadingDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                resultsContainer.style.display = 'none';
                
                // Get form values
                const sourceCountry = document.getElementById('source-country').value;
                const destCountry = document.getElementById('dest-country').value;
                const sourceCurrency = document.getElementById('source-currency').value;
                const destCurrency = document.getElementById('dest-currency').value;
                const amount = document.getElementById('amount').value;
                
                // Make API request
                try {
                    const response = await fetch(`http://localhost:8000/api/quotes/?source_country=${sourceCountry}&dest_country=${destCountry}&source_currency=${sourceCurrency}&dest_currency=${destCurrency}&amount=${amount}`);
                    const data = await response.json();
                    
                    // Hide loading indicator
                    loadingDiv.style.display = 'none';
                    
                    if (data.success) {
                        // Update cache status message
                        if (data.cache_hit && data.rate_calculation) {
                            cacheMessage.textContent = "ðŸ“Š Quotes calculated using cached corridor rates (Last updated: " + 
                                new Date(data.timestamp).toLocaleString() + ")";
                        } else if (data.cache_hit) {
                            cacheMessage.textContent = "ðŸ”„ Quotes loaded from cache (Last updated: " + 
                                new Date(data.timestamp).toLocaleString() + ")";
                        } else {
                            cacheMessage.textContent = "ðŸ”„ Fresh quotes loaded from providers (Updated just now)";
                        }
                        
                        // Show results and render quotes
                        resultsContainer.style.display = 'block';
                        renderQuotes(data);
                        
                        // Update active sort button
                        updateActiveSortButton(data.filters_applied?.sort_by || 'best_rate');
                    } else {
                        // Show error
                        errorDiv.style.display = 'block';
                        errorMessage.textContent = data.error || 'No quotes available for this corridor.';
                    }
                } catch (error) {
                    // Hide loading indicator and show error
                    loadingDiv.style.display = 'none';
                    errorDiv.style.display = 'block';
                    errorMessage.textContent = 'Error connecting to API. Please check that the server is running.';
                    console.error('API request error:', error);
                }
            });
            
            // Update active sort button
            function updateActiveSortButton(sortBy) {
                // Remove active class from all buttons
                [sortRateBtn, sortFeeBtn, sortTimeBtn].forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to the selected button
                if (sortBy === 'best_rate' || sortBy === 'rate') {
                    sortRateBtn.classList.add('active');
                } else if (sortBy === 'lowest_fee' || sortBy === 'fee') {
                    sortFeeBtn.classList.add('active');
                } else if (sortBy === 'fastest_time' || sortBy === 'time') {
                    sortTimeBtn.classList.add('active');
                }
            }
            
            // Set up sort button event listeners
            sortRateBtn.addEventListener('click', () => {
                updateActiveSortButton('best_rate');
                if (window.lastQuoteData) {
                    renderQuotes({...window.lastQuoteData, filters_applied: {sort_by: 'best_rate'}});
                }
            });
            
            sortFeeBtn.addEventListener('click', () => {
                updateActiveSortButton('lowest_fee');
                if (window.lastQuoteData) {
                    renderQuotes({...window.lastQuoteData, filters_applied: {sort_by: 'lowest_fee'}});
                }
            });
            
            sortTimeBtn.addEventListener('click', () => {
                updateActiveSortButton('fastest_time');
                if (window.lastQuoteData) {
                    renderQuotes({...window.lastQuoteData, filters_applied: {sort_by: 'fastest_time'}});
                }
            });
            
            // Function to render quotes
            function renderQuotes(data) {
                // Store the data for later use by sort buttons
                window.lastQuoteData = data;
                
                // Get sorting method
                const sortBy = data.filters_applied?.sort_by || 'best_rate';
                
                // Sort quotes based on the method
                let sortedQuotes = [...data.quotes];
                if (sortBy === 'best_rate' || sortBy === 'rate') {
                    sortedQuotes.sort((a, b) => (b.exchange_rate || 0) - (a.exchange_rate || 0));
                } else if (sortBy === 'lowest_fee' || sortBy === 'fee') {
                    sortedQuotes.sort((a, b) => (a.fee || Infinity) - (b.fee || Infinity));
                } else if (sortBy === 'fastest_time' || sortBy === 'time') {
                    sortedQuotes.sort((a, b) => (a.delivery_time_minutes || Infinity) - (b.delivery_time_minutes || Infinity));
                }
                
                // Display quotes with the sorted data
                displayQuotes({...data, quotes: sortedQuotes}, sortBy);
            }
            
            // Display quotes
            function displayQuotes(data, sortMethod) {
                // Clear results
                quoteList.innerHTML = '';
                
                // Check if we have results
                if (!data.quotes || data.quotes.length === 0) {
                    quoteList.innerHTML = '<p>No quotes available for this corridor.</p>';
                    return;
                }
                
                // Filter out entries with null/undefined critical values and remove duplicates
                const uniqueProviders = new Set();
                let filteredQuotes = data.quotes.filter(quote => {
                    // Skip if missing critical info
                    if (!quote.exchange_rate || 
                        !quote.destination_amount || 
                        quote.success === false) {
                        return false;
                    }
                    
                    // Check if we've already seen this provider
                    if (uniqueProviders.has(quote.provider_id)) {
                        return false;
                    }
                    
                    // Add to seen providers
                    uniqueProviders.add(quote.provider_id);
                    return true;
                });
                
                // Sort results based on method
                if (sortMethod === 'rate') {
                    // Sort by exchange rate (descending)
                    filteredQuotes.sort((a, b) => b.exchange_rate - a.exchange_rate);
                } else if (sortMethod === 'fee') {
                    // Sort by fee (ascending)
                    filteredQuotes.sort((a, b) => a.fee - b.fee);
                } else if (sortMethod === 'time') {
                    // Sort by delivery time (ascending)
                    filteredQuotes.sort((a, b) => {
                        // Handle null/undefined by placing them at the end
                        if (!a.delivery_time_minutes && !b.delivery_time_minutes) return 0;
                        if (!a.delivery_time_minutes) return 1;
                        if (!b.delivery_time_minutes) return -1;
                        return a.delivery_time_minutes - b.delivery_time_minutes;
                    });
                }
                
                // Limit to top 5 providers
                filteredQuotes = filteredQuotes.slice(0, 5);
                
                // Find the best in each category among our filtered quotes
                const bestRate = filteredQuotes.reduce((max, quote) => quote.exchange_rate > max.exchange_rate ? quote : max, filteredQuotes[0]);
                const bestFee = filteredQuotes.reduce((min, quote) => {
                    if (!min.fee) return quote;
                    if (!quote.fee) return min;
                    return quote.fee < min.fee ? quote : min;
                }, filteredQuotes[0]);
                const fastest = filteredQuotes.reduce((min, quote) => {
                    if (!min.delivery_time_minutes) return quote;
                    if (!quote.delivery_time_minutes) return min;
                    return quote.delivery_time_minutes < min.delivery_time_minutes ? quote : min;
                }, filteredQuotes[0]);
                
                // Display quotes
                filteredQuotes.forEach(quote => {
                    // Create quote card
                    const card = document.createElement('div');
                    card.className = 'quote-card';
                    
                    // Add special highlighting
                    if (quote.provider_id === bestRate.provider_id) {
                        card.classList.add('best-rate');
                    }
                    if (bestFee && quote.provider_id === bestFee.provider_id) {
                        card.classList.add('best-fee');
                    }
                    if (fastest && quote.provider_id === fastest.provider_id) {
                        card.classList.add('fastest');
                    }
                    
                    // Format details and ensure values are defined
                    const deliveryTime = formatDeliveryTime(quote.delivery_time_minutes);
                    const sourceAmount = quote.source_amount || quote.send_amount || data.amount || 1000;
                    const sourceCurrency = quote.source_currency || quote.send_currency || data.source_currency || 'USD';
                    const destinationAmount = quote.destination_amount || quote.receive_amount;
                    const destinationCurrency = quote.destination_currency || quote.receive_currency || data.dest_currency || 'MXN';
                    
                    // Card content
                    card.innerHTML = `
                        <div class="provider-name">${quote.provider_name || quote.provider_id}</div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Send:</span>
                            <span>${sourceAmount} ${sourceCurrency}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Receive:</span>
                            <span>${destinationAmount} ${destinationCurrency}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Exchange Rate:</span>
                            <span>1 ${sourceCurrency} = ${quote.exchange_rate} ${destinationCurrency}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Fee:</span>
                            <span>${quote.fee || 0} ${sourceCurrency}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Payment Method:</span>
                            <span>${quote.payment_method || 'Various'}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Delivery Method:</span>
                            <span>${quote.delivery_method || 'Various'}</span>
                        </div>
                        
                        <div class="quote-detail">
                            <span class="detail-label">Delivery Time:</span>
                            <span>${deliveryTime}</span>
                        </div>
                    `;
                    
                    // Add to results
                    quoteList.appendChild(card);
                });
            }
            
            // Format delivery time
            function formatDeliveryTime(minutes) {
                if (!minutes) return 'Unknown';
                
                if (minutes < 60) {
                    return `${minutes} minutes`;
                } else if (minutes < 1440) {
                    const hours = Math.floor(minutes / 60);
                    return `${hours} hour${hours > 1 ? 's' : ''}`;
                } else {
                    const days = Math.floor(minutes / 1440);
                    return `${days} day${days > 1 ? 's' : ''}`;
                }
            }
        });
    </script>
</body>
</html> 
# Caching System: Implementation and Issues

## Overview

RemitScout uses a Redis-based caching system implemented with django-redis to improve performance. We cache various types of data:

1. **Quote responses**: Complete quote data for specific corridors and amounts
2. **Corridor rates**: Exchange rates, fee structures, and other rate data that doesn't change with amount
3. **Corridor availability**: Whether a given corridor is supported by any provider
4. **Provider details**: Provider-specific information

## Caching Strategy

Our caching strategy has multiple layers:

1. **Exact match cache**: The first check looks for an exact match of source country, destination country, source currency, destination currency, and amount
2. **Corridor availability cache**: The second check determines if a given corridor is supported
3. **Corridor rate cache**: The third check uses cached rate information to calculate quotes for different amounts
4. **Fresh aggregator data**: If no cache hits, we fetch fresh data from the aggregator

## Troubleshooting Caching Issues

### Common Issue: Cache Miss When Expected Hit

If you're experiencing cache misses when you expect hits:

1. **Check key generation**: Ensure cache keys are consistently generated
2. **Use Django's cache interface**: Always use Django's cache interface (`cache.get`, `cache.set`) rather than direct Redis commands
3. **Check serialization**: Django-redis uses Pickle serialization by default, not JSON

### Redis Key Format

Django-redis stores keys with this format: `{prefix}:{version}:{key}`

- `prefix`: Set in `settings.py` as `KEY_PREFIX` (default: "remitscout")
- `version`: Cache version (default: 1)
- `key`: The cache key generated by our key generators

Example: `remitscout:1:v1:fee:GB:MX:GBP:MXN:500.0`

### Debugging Cache Issues

To debug caching issues:

1. Check if the key exists in Redis:
   ```
   redis-cli -n 1 keys "remitscout:1:v1:fee:*"
   ```

2. Use a Python script to test the cache:
   ```python
   from django.core.cache import cache
   from quotes.key_generators import get_quote_cache_key

   # Generate a cache key
   cache_key = get_quote_cache_key("GB", "MX", "GBP", "MXN", 500.0)
   
   # Check if it exists
   cached_data = cache.get(cache_key)
   print(f"Found in cache: {cached_data is not None}")
   ```

3. Use the Django shell to test:
   ```
   python manage.py shell
   ```

### Solution to Serialization Issues

Always use Django's cache API for setting and getting cached values:

```python
# Correct approach
from django.core.cache import cache
from quotes.key_generators import get_quote_cache_key

# Generate cache key
cache_key = get_quote_cache_key(source_country, dest_country, source_currency, dest_currency, amount)

# Set value
cache.set(cache_key, data, timeout=300)  # 5 minutes

# Get value
cached_data = cache.get(cache_key)
```

Do not directly manipulate Redis keys using the Redis client, as this will bypass Django's serialization:

```python
# INCORRECT approach
import redis
import json

r = redis.Redis(host='localhost', port=6379, db=1)
key = f"remitscout:1:v1:fee:{source_country}:{dest_country}:{source_currency}:{dest_currency}:{float(amount)}"
r.set(key, json.dumps(data))  # This will not be readable by Django's cache
```

## Cache TTL Settings

We use the following cache timeouts:

- `QUOTE_CACHE_TTL`: 30 minutes for quotes
- `CORRIDOR_CACHE_TTL`: 12 hours for corridor availability
- `CORRIDOR_RATE_CACHE_TTL`: 3 hours for corridor rate data
- `PROVIDER_CACHE_TTL`: 24 hours for provider details

These are defined in `settings.py` and can be adjusted based on your needs. 